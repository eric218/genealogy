package com.dct.swocean.controller;

import java.io.File;
import java.io.FileInputStream;
import java.io.OutputStream;

import javax.servlet.http.HttpServletResponse;

import org.apache.catalina.servlet4preview.http.HttpServletRequest;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import com.alibaba.fastjson.JSONObject;
import com.dct.swocean.common.ConstantClassField;
import com.dct.swocean.util.DateUtil;
import com.dct.swocean.util.ExceptionHandle;
import com.dct.swocean.util.ImageRemarkUtil;

@Controller
@RequestMapping("/imageRemark")
public class ImageRemarkController
{
    private final static Logger logger = LoggerFactory.getLogger(ImageRemarkController.class);
    
    @RequestMapping("/test")
    @ResponseBody
    public String login(HttpServletRequest request, String json, HttpServletResponse response)
    {
        FileInputStream fis = null;
        response.setContentType("image/gif");
        try
        {
            JSONObject jsonObj = JSONObject.parseObject(json);
            int positionWidth = jsonObj.getInteger("positionWidth");
            int positionHeight = jsonObj.getInteger("positionHeight");
            int degree = jsonObj.getInteger("degree");
            ImageRemarkUtil.setImageMarkOptions(0, positionWidth, positionHeight, null, null);
            String imgSrcPath = "E:/WORK/1.png";
            String imgPath = "E:/WORK/add.png";
            ImageRemarkUtil.markImageByText("我是水印", imgSrcPath ,imgPath,degree,true);

            OutputStream out = response.getOutputStream();
            File file = new File(imgPath);
            fis = new FileInputStream(file);
            byte[] b = new byte[fis.available()];
            fis.read(b);
            out.write(b);
            out.flush();
        }
        catch (Exception e)
        {
            logger.error(ExceptionHandle.getExceptionJson(e, request.getRequestURI()), ConstantClassField.ERROR_LOG,
                    "用户名", DateUtil.getTime());
        }
        return "test";
    }
}

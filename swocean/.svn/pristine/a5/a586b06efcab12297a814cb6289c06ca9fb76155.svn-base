package com.dct.swocean.util;

import java.awt.Image;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;

import javax.imageio.ImageIO;

import com.sun.image.codec.jpeg.JPEGCodec;
import com.sun.image.codec.jpeg.JPEGImageEncoder;

/**
 * @author xiechi
 * 图像压缩、裁剪、调整大小
 *
 */
@SuppressWarnings("restriction")
public class ImageOperateUtil {
	
	private static String fileNameNew = "";

	public static void main(String[] args) {
		ImageOperateUtil util = new ImageOperateUtil();
		String fileName = "D:/temp/woman.jpg";
		int size = 200;
		boolean isWidth = false;
		try {
			fileNameNew = "cut.jpg";
			File file = new File(fileName);//读入文件
			BufferedImage img = ImageIO.read(file);//构造Image对象
	        BufferedImage image = util.cropImage(img, 200, 300, 100, 150);
			System.out.println(image);
			
		} catch (Exception e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
	}
	/**
	 * 图像压缩
	 * @param fileName 文件路径
	 * @param size 最小宽/高
	 * @param isWidth 是否是等宽压缩
	 * @throws IOException
	 */
	public BufferedImage ImgCompress(String fileName,int size,boolean isWidth) throws IOException {  
        File file = new File(fileName);//读入文件
        BufferedImage img = ImageIO.read(file);//构造Image对象
        int width = img.getWidth(null);//得到源图宽
    	int height = img.getHeight(null);//得到源图长
    	BufferedImage image = null;
        if(isWidth){
        	//以宽度为基准，等比例放缩图片 
        	int h = (int) (height * size / width);
        	image = resize(img,size,h);
        }else{
        	//以高度为基准，等比例缩放图片
        	int w = (int) (width * size / height);
        	image = resize(img,w,size);
        }
        return image;
    }
	
	/**
	 * 调整图片大小:强制压缩/放大图片到固定的大小
	 * @param img	图像对象
	 * @param w	int 新宽度
	 * @param h	int 新高度
	 * @throws IOException
	 */
    public BufferedImage resize(Image img, int w, int h) throws IOException {
        // SCALE_SMOOTH 的缩略算法 生成缩略图片的平滑度的 优先级比速度高 生成的图片质量比较好 但速度慢
        BufferedImage image = new BufferedImage(w, h,BufferedImage.TYPE_INT_RGB );
        image.getGraphics().drawImage(img, 0, 0, w, h, null);//绘制缩小后的图
//        image.getGraphics().drawImage(img.getScaledInstance(w, h, Image.SCALE_SMOOTH), 0, 0, null);
        
        File destFile = new File("D:\\temp\\"+fileNameNew);
        FileOutputStream out = new FileOutputStream(destFile);//输出到文件流
        // 可以正常实现bmp、png、gif转jpg
        JPEGImageEncoder encoder = JPEGCodec.createJPEGEncoder(out);
        encoder.encode(image);//JPEG编码
        out.close();
        
        return image;
    }
    
    public BufferedImage cropImage(BufferedImage bufferedImage, int startX, int startY, int width, int height) throws Exception {
        int w = bufferedImage.getWidth();
        int h = bufferedImage.getHeight();
        if (startX == -1) {
            startX = 0;
        }
        if (startY == -1) {
            startY = 0;
        }
        BufferedImage result = new BufferedImage(width, height,4);
        for (int x = startX; x < (startX+width); ++x) {
            for (int y = startY; y < (startY+height); ++y) {
                int rgb = bufferedImage.getRGB(x, y);
                result.setRGB(x - startX, y - startY, rgb);
            }
        }
        
        File destFile = new File("D:\\temp\\"+fileNameNew);
        FileOutputStream out = new FileOutputStream(destFile);//输出到文件流
        // 可以正常实现bmp、png、gif转jpg
        JPEGImageEncoder encoder = JPEGCodec.createJPEGEncoder(out);
        encoder.encode(result);//JPEG编码
        out.close();
        
        return result;
    }
}
